name: Publish Pages

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/publish-pages.yml"
  workflow_run:
    workflows: [Publish Firmware]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - run: npm run docs:build
      - run: mkdir -p docs/.vitepress/dist/firmware
      - uses: robinraju/release-downloader@v1
        with:
          latest: true
          fileName: "*"
          out-file-path: docs/.vitepress/dist/firmware
        continue-on-error: true
      - name: Add ESP32-P4 build to manifest
        run: |
          FW="docs/.vitepress/dist/firmware"
          MANIFEST="${FW}/media-player.manifest.json"
          FACTORY="${FW}/media-player-esp32p4.factory.bin"
          OTA="${FW}/media-player-esp32p4.ota.bin"

          if [ ! -f "$MANIFEST" ] || [ ! -f "$FACTORY" ]; then
            echo "Manifest or P4 factory binary not found; skipping."
            exit 0
          fi

          FACTORY_MD5=$(md5sum "$FACTORY" | awk '{print $1}')
          FACTORY_SHA256=$(sha256sum "$FACTORY" | awk '{print $1}')

          P4_BUILD=$(jq -n \
            --arg fm "$FACTORY_MD5" \
            --arg fs "$FACTORY_SHA256" \
            '{
              chipFamily: "ESP32-P4",
              parts: [{
                path: "media-player-esp32p4.factory.bin",
                offset: 0,
                md5: $fm,
                sha256: $fs
              }]
            }')

          if [ -f "$OTA" ]; then
            OTA_MD5=$(md5sum "$OTA" | awk '{print $1}')
            OTA_SHA256=$(sha256sum "$OTA" | awk '{print $1}')
            SUMMARY=$(jq -r '.builds[0].ota.summary // empty' "$MANIFEST")
            RELEASE_URL=$(jq -r '.builds[0].ota.release_url // empty' "$MANIFEST")
            P4_BUILD=$(echo "$P4_BUILD" | jq \
              --arg om "$OTA_MD5" \
              --arg os "$OTA_SHA256" \
              --arg summary "$SUMMARY" \
              --arg url "$RELEASE_URL" \
              '. + {ota: {path: "media-player-esp32p4.ota.bin", md5: $om, sha256: $os, summary: $summary, release_url: $url}}')
          fi

          jq --argjson p4 "$P4_BUILD" '.builds += [$p4]' "$MANIFEST" > "${MANIFEST}.tmp"
          mv "${MANIFEST}.tmp" "$MANIFEST"
          echo "ESP32-P4 build added to manifest."
      - name: Generate per-device manifests
        run: |
          FW="docs/.vitepress/dist/firmware"
          MANIFEST="${FW}/media-player.manifest.json"

          if [ ! -f "$MANIFEST" ]; then
            echo "Combined manifest not found; skipping per-device manifests."
            exit 0
          fi

          # S3 device manifest (4848S040) — extract the ESP32-S3 build entry
          jq '{name: .name, version: .version, home_assistant_domain: .home_assistant_domain, new_install_prompt_erase: .new_install_prompt_erase, builds: [.builds[] | select(.chipFamily == "ESP32-S3")]}' \
            "$MANIFEST" > "${FW}/media-player-4848s040.manifest.json"
          echo "Created media-player-4848s040.manifest.json"

          # P4 device manifest (JC8012P4A1) — extract the ESP32-P4 build entry
          jq '{name: .name, version: .version, home_assistant_domain: .home_assistant_domain, new_install_prompt_erase: .new_install_prompt_erase, builds: [.builds[] | select(.chipFamily == "ESP32-P4")]}' \
            "$MANIFEST" > "${FW}/media-player-jc8012p4a1.manifest.json"
          echo "Created media-player-jc8012p4a1.manifest.json"
      - uses: actions/upload-pages-artifact@v4
        with:
          path: docs/.vitepress/dist
          retention-days: 1

  publish:
    if: github.event_name != 'pull_request'
    name: Publish
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/configure-pages@v5
      - id: deployment
        uses: actions/deploy-pages@v4
