# =============================================================================
# MUSIC DASHBOARD - HTTP request, album art image
# =============================================================================
# Required for online_image (album art from Home Assistant entity_picture).
# Placeholder image shown until art is downloaded.
# =============================================================================

http_request:
  id: http_req

# Placeholder shown while album art is loading or when no art is available.
image:
  - file: "https://placehold.co/480x480/2d2d2d/555555"
    id: album_art_placeholder
    type: rgb565
  - file: "https://raw.githubusercontent.com/jtenniswood/esphome-media-player/main/guition-esp32-s3-4848s040/assets/gradient.png"
    id: bottom_gradient
    type: RGB565
    transparency: alpha_channel

# Dynamic album art from media_player entity_picture (URL set by sensors.yaml).
# Decoded at 480x480 to match the physical display resolution (1:1 pixel mapping).
online_image:
  - url: "https://placehold.co/480x480/2d2d2d/555555"
    id: album_art_background
    type: rgb565
    format: jpeg
    placeholder: album_art_placeholder
    resize: 480x480
    on_download_finished:
      - lvgl.widget.hide: artwork_error_label
      - lambda: |-
          lv_img_set_zoom(id(album_art_background_widget), 256);
          lv_obj_set_pos(id(album_art_background_widget), 0, 0);
          lv_obj_set_size(id(album_art_background_widget), 480, 480);
      - lvgl.image.update:
          id: album_art_background_widget
          src: album_art_background
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 100%
    on_error:
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 40%
      - lvgl.widget.show: artwork_error_label

  # TV mode main background â€” no forced resize so aspect ratio is preserved.
  # After download, the widget is scaled to fit within 480x480 and centered.
  - url: "https://placehold.co/480x270/2d2d2d/555555"
    id: tv_art_background
    type: rgb565
    format: jpeg
    placeholder: album_art_placeholder
    on_download_finished:
      - lvgl.widget.hide: artwork_error_label
      - lvgl.image.update:
          id: album_art_background_widget
          src: tv_art_background
      - lambda: |-
          int img_w = id(tv_art_background)->get_width();
          int img_h = id(tv_art_background)->get_height();

          // Scale to fit within 480x480 while preserving aspect ratio
          int zoom = 256;
          if (img_w > 480 || img_h > 480) {
            float sx = 480.0f / (float)img_w;
            float sy = 480.0f / (float)img_h;
            float scale = (sx < sy) ? sx : sy;
            zoom = (int)(scale * 256.0f);
          }
          lv_img_set_zoom(id(album_art_background_widget), zoom);

          int disp_w = (img_w * zoom) / 256;
          int disp_h = (img_h * zoom) / 256;

          // Size widget to image (prevents tiling) and center on screen
          lv_obj_set_size(id(album_art_background_widget), disp_w, disp_h);
          lv_obj_set_pos(id(album_art_background_widget), (480 - disp_w) / 2, (480 - disp_h) / 2);
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 100%
    on_error:
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 40%
      - lvgl.widget.show: artwork_error_label
