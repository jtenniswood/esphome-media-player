# =============================================================================
# MUSIC DASHBOARD - HTTP request, album art image, accent color
# =============================================================================
# Required for online_image (album art from Home Assistant entity_picture).
# Placeholder image shown until art is downloaded.
#
# Accent color: a virtual RGB light whose color is set by HA's color_extractor
# integration. In TV mode the dominant album-art color is applied as the LVGL
# page background behind the letterboxed image.
# =============================================================================

http_request:
  id: http_req

# Placeholder shown while album art is loading or when no art is available.
image:
  - file: "https://placehold.co/480x480/2d2d2d/555555"
    id: album_art_placeholder
    type: rgb565
  - file: "https://raw.githubusercontent.com/jtenniswood/esphome-media-player/main/guition-esp32-s3-4848s040/assets/gradient.png"
    id: bottom_gradient
    type: RGB565
    transparency: alpha_channel

# Dynamic album art from media_player entity_picture (URL set by sensors.yaml).
# Decoded at 480x480 to match the physical display resolution (1:1 pixel mapping).
online_image:
  - url: "https://placehold.co/480x480/2d2d2d/555555"
    id: album_art_background
    type: rgb565
    format: jpeg
    placeholder: album_art_placeholder
    resize: 480x480
    on_download_finished:
      - lvgl.widget.hide: artwork_error_label
      - lambda: |-
          auto *w = id(album_art_background_widget);
          lv_img_set_zoom(w, 256);
          lv_img_set_offset_x(w, 0);
          lv_img_set_offset_y(w, 0);
          lv_obj_set_size(w, 480, 480);
          lv_obj_set_pos(w, 0, 0);
      - lvgl.image.update:
          id: album_art_background_widget
          src: album_art_background
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 100%
    on_error:
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 40%
      - lvgl.widget.show: artwork_error_label

  # TV mode main background — no forced resize so aspect ratio is preserved.
  # After download, zoom is calculated to contain the image within 480x480,
  # the widget auto-sizes to the zoomed result, and is centered on screen.
  - url: "https://placehold.co/480x270/2d2d2d/555555"
    id: tv_art_background
    type: rgb565
    format: jpeg
    placeholder: album_art_placeholder
    on_download_finished:
      - lvgl.widget.hide: artwork_error_label
      - lvgl.image.update:
          id: album_art_background_widget
          src: tv_art_background
      - lambda: |-
          auto *w = id(album_art_background_widget);
          int img_w = id(tv_art_background)->get_width();
          int img_h = id(tv_art_background)->get_height();

          int zoom = 256;
          if (img_w > 480 || img_h > 480) {
            float sx = 480.0f / (float)img_w;
            float sy = 480.0f / (float)img_h;
            float scale = (sx < sy) ? sx : sy;
            zoom = (int)(scale * 256.0f);
          }

          lv_img_set_zoom(w, zoom);
          lv_img_set_offset_x(w, 0);
          lv_img_set_offset_y(w, 0);
          lv_obj_set_size(w, LV_SIZE_CONTENT, LV_SIZE_CONTENT);
          lv_obj_update_layout(lv_obj_get_parent(w));
          lv_obj_align(w, LV_ALIGN_CENTER, 0, 0);
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 100%
    on_error:
      - lvgl.widget.update:
          id: album_art_background_widget
          opa: 40%
      - lvgl.widget.show: artwork_error_label

# -----------------------------------------------------------------------------
# ACCENT COLOR LIGHT (virtual RGB — no physical hardware)
# -----------------------------------------------------------------------------
# Exposed to HA so color_extractor can target it via light.turn_on with
# color_extract_url. The on_state callback applies the extracted color as
# the LVGL page background when in TV mode.
# -----------------------------------------------------------------------------
output:
  - platform: template
    id: accent_red
    type: float
    write_action:
      - lambda: ''
  - platform: template
    id: accent_green
    type: float
    write_action:
      - lambda: ''
  - platform: template
    id: accent_blue
    type: float
    write_action:
      - lambda: ''

light:
  - platform: rgb
    name: "Accent Color"
    id: accent_color_light
    red: accent_red
    green: accent_green
    blue: accent_blue
    default_transition_length: 0s
    entity_category: config
    icon: "mdi:palette"
    on_state:
      - if:
          condition:
            lambda: 'return id(is_tv_mode);'
          then:
            - lambda: |-
                float r, g, b;
                id(accent_color_light)->current_values_as_rgb(&r, &g, &b);
                lv_obj_set_style_bg_color(id(main_page),
                  lv_color_make((int)(r * 255), (int)(g * 255), (int)(b * 255)), 0);

# -----------------------------------------------------------------------------
# ACCENT COLOR EXTRACTION SCRIPT
# -----------------------------------------------------------------------------
# Calls light.turn_on with color_extract_url so HA's color_extractor
# integration extracts the dominant color and applies it to the accent light.
# -----------------------------------------------------------------------------
script:
  - id: extract_accent_color
    mode: restart
    then:
      - homeassistant.service:
          service: light.turn_on
          variables:
            target_entity: !lambda |-
              std::string n = App.get_name();
              for (auto &c : n) if (c == '-') c = '_';
              return "light." + n + "_accent_color";
            image_url: !lambda |-
              std::string path = id(is_tv_mode)
                ? id(tv_entity_picture_sensor).state
                : id(media_entity_picture_sensor).state;
              while (!path.empty() && (path.back() == '\n' || path.back() == '\r' || path.back() == ' '))
                path.pop_back();
              if (path.substr(0, 7) == "http://" || path.substr(0, 8) == "https://")
                return path;
              return id(ha_base_url) + path;
          data_template:
            entity_id: "{{ target_entity }}"
            color_extract_url: "{{ image_url }}"
