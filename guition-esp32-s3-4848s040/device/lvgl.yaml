# =============================================================================
# LVGL MUSIC DASHBOARD
# =============================================================================
# Single-screen now-playing view for Sonos (media_player.office).
# Data from sensors.yaml; album art from online_image (addon/music.yaml).
# =============================================================================

lvgl:
  buffer_size: 100%

  pages:
    - id: main_page
      scrollbar_mode: "off"
      scrollable: false
      width: 100%
      height: 100%
      bg_color: 0x000000
      pad_top: 0
      pad_bottom: 0
      pad_left: 0
      pad_right: 0

      widgets:
        # Full-screen artwork background
        - image:
            id: album_art_background_widget
            x: 0
            y: 0
            width: 480px
            height: 480px
            src: album_art_background
            opa: 100%

        # Error label: shown when album art download fails
        - label:
            id: artwork_error_label
            text: "Artwork unavailable"
            align: center
            y: -40
            width: 300px
            height: 30px
            text_font: roboto19_font
            text_color: 0x888888
            text_align: center
            hidden: true

        # Gradient overlay behind the bottom controls
        - image:
            id: bottom_overlay
            x: 0
            y: 350
            width: 480
            height: 130
            src: bottom_gradient

        # Song title
        - label:
            id: media_title_label
            text: "—"
            x: 18
            y: 356
            width: 370px
            height: 30px
            long_mode: dot
            text_font: roboto30_font
            text_color: 0xFFFFFF
            text_align: left

        # Artist name
        - label:
            id: media_artist_label
            text: "—"
            x: 18
            y: 396
            width: 370px
            height: 24px
            long_mode: dot
            text_font: roboto19_font
            text_color: 0xFFFFFF
            text_align: left

        # Control buttons: 72px round; play/pause + next aligned to the right
        # Play/pause: two icon labels; visibility toggled by sensors.yaml from state
        - button:
            id: media_play_pause_button
            x: 390
            y: 356
            width: 72px
            height: 72px
            styles: control_round
            widgets:
              - label:
                  id: media_play_icon
                  text_font: $icon_font
                  align: center
                  text: $play
                  text_color: 0xFFFFFF
                  hidden: false
              - label:
                  id: media_pause_icon
                  text_font: $icon_font
                  align: center
                  text: $pause
                  text_color: 0xFFFFFF
                  hidden: true
            on_press:
              - homeassistant.service:
                  service: media_player.media_play_pause
                  data:
                    entity_id: ${media_player}

        # TV mode: centered TV icon, shown only when source is "TV"
        - label:
            id: tv_source_label
            text: $tv_icon
            align: center
            y: -60
            text_font: icon_font_large
            text_color: 0xFFFFFF
            hidden: true

        # Play clock: elapsed / duration, below artist name
        - label:
            id: media_time_label
            text: "0:00  /  0:00"
            x: 18
            y: 428
            width: 150px
            text_font: roboto15_font
            text_color: 0xDDDDDD
            text_align: left

        # Progress bar: full screen width, at the very bottom of the screen
        - bar:
            id: media_progress_bar
            x: 0
            y: 474
            width: 480
            height: 6
            bg_color: 0x000000
            bg_opa: 50%
            radius: 0
            min_value: 0
            max_value: 100
            value: 0
            indicator:
              bg_color: 0xFFFFFF
              radius: 0

        # ---------------------------------------------------------------
        # SETTINGS PANEL (swipe-down from top)
        # ---------------------------------------------------------------
        # Full-screen overlay, starts hidden. Shown/hidden instantly by
        # open_settings_panel / close_settings_panel scripts in device.yaml.
        # ---------------------------------------------------------------
        - obj:
            id: settings_panel
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            widgets:
              # Interactive arc volume control (270 deg, gap at bottom)
              - arc:
                  id: volume_arc
                  align: center
                  y: -10
                  width: 380
                  height: 380
                  min_value: 0
                  max_value: 100
                  value: 30
                  adjustable: true
                  arc_color: 0x333333
                  arc_width: 12
                  arc_rounded: true
                  indicator:
                    arc_color: 0x999999
                    arc_width: 12
                    arc_rounded: true
                  knob:
                    bg_color: 0xFFFFFF
                    radius: 14
                    width: 28
                    height: 28
                    border_width: 0
                  on_value:
                    - lvgl.label.update:
                        id: volume_pct_label
                        text: !lambda |-
                          char buf[8];
                          snprintf(buf, sizeof(buf), "%d%%", (int)x);
                          return std::string(buf);
                    - homeassistant.service:
                        service: media_player.volume_set
                        data:
                          entity_id: ${media_player}
                        variables:
                          vol_level: !lambda 'return x / 100.0f;'
                        data_template:
                          volume_level: "{{ vol_level }}"

              # "Volume" label above the percentage
              - label:
                  id: volume_title_label
                  text: "Volume"
                  text_font: roboto19_font
                  text_color: 0x888888
                  align: center
                  y: -60
                  width: 140
                  height: 24
                  text_align: center

              # Large centered percentage label (overlaid on top of the arc)
              - label:
                  id: volume_pct_label
                  text: "30%"
                  text_font: roboto56_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -10
                  width: 200
                  height: 60
                  text_align: center

              # Volume down button
              - button:
                  id: volume_down_button
                  align: center
                  x: -48
                  y: 135
                  width: 72px
                  height: 72px
                  styles: control_round
                  widgets:
                    - label:
                        text_font: $icon_font
                        align: center
                        text: $icon_minus
                        text_color: 0xFFFFFF
                  on_press:
                    - homeassistant.service:
                        service: media_player.volume_set
                        data:
                          entity_id: ${media_player}
                        variables:
                          vol_level: !lambda |-
                            float v = id(media_volume_sensor).state - 0.01f;
                            if (v < 0.0f) v = 0.0f;
                            return v;
                        data_template:
                          volume_level: "{{ vol_level }}"

              # Volume up button
              - button:
                  id: volume_up_button
                  align: center
                  x: 48
                  y: 135
                  width: 72px
                  height: 72px
                  styles: control_round
                  widgets:
                    - label:
                        text_font: $icon_font
                        align: center
                        text: $icon_plus
                        text_color: 0xFFFFFF
                  on_press:
                    - homeassistant.service:
                        service: media_player.volume_set
                        data:
                          entity_id: ${media_player}
                        variables:
                          vol_level: !lambda |-
                            float v = id(media_volume_sensor).state + 0.01f;
                            if (v > 1.0f) v = 1.0f;
                            return v;
                        data_template:
                          volume_level: "{{ vol_level }}"

              # Drag handle indicator (visual cue to swipe up to close)
              - obj:
                  x: 210
                  y: 466
                  width: 60
                  height: 4
                  bg_color: 0x666666
                  bg_opa: 100%
                  radius: 2
                  border_width: 0
                  pad_all: 0
                  scrollable: false
