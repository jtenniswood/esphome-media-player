# =============================================================================
# LVGL MUSIC DASHBOARD
# =============================================================================
# Single-screen now-playing view for any Home Assistant media player.
# Data from sensors.yaml; album art from online_image (addon/music.yaml).
# =============================================================================

lvgl:
  buffer_size: 25%

  pages:
    - id: main_page
      scrollbar_mode: "off"
      scrollable: false
      width: 100%
      height: 100%
      bg_color: 0x000000
      pad_top: 0
      pad_bottom: 0
      pad_left: 0
      pad_right: 0

      widgets:
        # Full-screen artwork background
        - image:
            id: album_art_background_widget
            x: 0
            y: 0
            width: 480px
            height: 480px
            src: album_art_background
            opa: 100%

        # Error label: shown when album art download fails
        - label:
            id: artwork_error_label
            text: "Artwork unavailable"
            align: center
            y: -40
            width: 300px
            height: 30px
            text_font: roboto19_font
            text_color: 0x888888
            text_align: center
            hidden: true

        # Darkening layer over artwork (separate from text so transparency works)
        - obj:
            id: track_info_overlay
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 80%
            opa: 80%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            clickable: false

        # Track info + controls (flex column over darkening layer)
        - obj:
            id: track_info_text
            x: 0
            y: 0
            width: 480
            height: 480
            bg_opa: 0%
            radius: 0
            border_width: 0
            pad_left: 24
            pad_right: 24
            pad_top: 24
            pad_bottom: 24
            scrollable: false
            scrollbar_mode: "off"
            clickable: false
            layout:
              type: flex
              flex_flow: COLUMN
              pad_row: 0
            widgets:
              - label:
                  id: media_title_label
                  text: "â€”"
                  width: 100%
                  max_height: 252px
                  long_mode: dot
                  text_font: roboto_light70_font
                  text_color: 0xFFFFFF
                  text_align: left
              - label:
                  id: media_artist_label
                  text: ""
                  pad_top: 6
                  width: 100%
                  long_mode: dot
                  text_font: roboto_light40_font
                  text_color: 0xFFFFFF
                  text_opa: 80%
                  text_align: left
                  hidden: true
              - obj:
                  flex_grow: 1
                  width: 100%
                  bg_opa: 0%
                  border_width: 0
                  pad_all: 0
                  scrollable: false
                  clickable: false
              - obj:
                  width: 100%
                  height: 96px
                  bg_opa: 0%
                  border_width: 0
                  pad_all: 0
                  scrollable: false
                  clickable: false
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_cross: center
                    pad_column: 0
                  widgets:
                    - label:
                        id: media_time_label
                        text: "0:00  /  0:00"
                        text_font: roboto20_font
                        text_color: 0xFFFFFF
                        text_opa: 80%
                        text_align: left
                        on_click:
                          - switch.toggle: show_remaining_time
                    - obj:
                        flex_grow: 1
                        height: 1px
                        bg_opa: 0%
                        border_width: 0
                        pad_all: 0
                        scrollable: false
                        clickable: false
                    - button:
                        id: media_play_pause_button
                        width: 96px
                        height: 96px
                        styles: control_round
                        widgets:
                          - label:
                              id: media_play_icon
                              text_font: icon_font_large
                              align: center
                              text: $play
                              text_color: 0xFFFFFF
                              hidden: false
                          - label:
                              id: media_pause_icon
                              text_font: icon_font_large
                              align: center
                              text: $pause
                              text_color: 0xFFFFFF
                              hidden: true
                        on_press:
                          - homeassistant.service:
                              service: media_player.media_play_pause
                              variables:
                                target: !lambda |-
                                  if (id(is_tv_mode)) return id(tv_media_player_entity).state;
                                  return id(media_player_entity).state;
                              data_template:
                                entity_id: "{{ target }}"
                              on_error:
                                - lvgl.widget.show: actions_prompt
                          - event.trigger:
                              id: media_control_event
                              event_type: play_pause
                          - logger.log: "Media: play_pause"

        # Progress bar: full screen width, at the very bottom of the screen
        - bar:
            id: media_progress_bar
            x: 0
            y: 474
            width: 480
            height: 6
            bg_color: 0x000000
            bg_opa: 50%
            radius: 0
            min_value: 0
            max_value: 100
            value: 0
            indicator:
              bg_color: 0xFFFFFF
              radius: 0

        # ---------------------------------------------------------------
        # SETUP PROMPT (no media player entity configured)
        # ---------------------------------------------------------------
        # Shown by subscribe_media_player when entity is empty.
        # Placed after controls so it covers them.
        # ---------------------------------------------------------------
        - obj:
            id: setup_prompt
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            widgets:
              - label:
                  text_font: $icon_font
                  align: center
                  y: -80
                  text: $icon_cast
                  text_color: 0xFFFFFF
              - label:
                  text: "Media Player"
                  text_font: roboto30_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -20
                  width: 400
                  height: 36
                  text_align: center
              - label:
                  text: "Set the media player entity\nyou want to control in\ndevice settings"
                  text_font: roboto19_font
                  text_color: 0x888888
                  align: center
                  y: 40
                  width: 400
                  height: 80
                  text_align: center

        # ---------------------------------------------------------------
        # ACTIONS PROMPT (enable HA actions toggle)
        # ---------------------------------------------------------------
        # One-time prompt shown after the media player entity is set.
        # Tap to dismiss; persisted via actions_prompt_acked global.
        # ---------------------------------------------------------------
        - obj:
            id: actions_prompt
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_left: 30
            pad_right: 30
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            layout:
              type: flex
              flex_flow: COLUMN
              flex_align_main: center
              flex_align_cross: center
              pad_row: 12
            widgets:
              - label:
                  text_font: $icon_font
                  text: $icon_shield
                  text_color: 0xFFFFFF
              - label:
                  text: "Enable Actions"
                  text_font: roboto30_font
                  text_color: 0xFFFFFF
                  width: 420
                  text_align: center
              - label:
                  id: actions_instructions
                  text: "In Home Assistant, go to\nSettings > Devices > ESPHome\nFind the device and enable\n'Allow the device to perform\nHome Assistant actions'"
                  text_font: roboto19_font
                  text_color: 0x888888
                  width: 420
                  text_align: center
              - button:
                  width: 180
                  height: 44
                  radius: 22
                  bg_color: 0xFFFFFF
                  border_width: 0
                  pad_all: 0
                  widgets:
                    - label:
                        text: "Understood"
                        text_font: roboto19_font
                        text_color: 0x000000
                        align: center

        # ---------------------------------------------------------------
        # SETTINGS PANEL (swipe-down from top)
        # ---------------------------------------------------------------
        # Full-screen overlay, starts hidden. Shown/hidden instantly by
        # open_settings_panel / close_settings_panel scripts in device.yaml.
        # ---------------------------------------------------------------
        - obj:
            id: settings_panel
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            widgets:
              # Interactive arc volume control (270 deg, gap at bottom)
              - arc:
                  id: volume_arc
                  align: center
                  y: -10
                  width: 380
                  height: 380
                  min_value: 0
                  max_value: 100
                  value: 30
                  adjustable: true
                  arc_color: 0x333333
                  arc_width: 12
                  arc_rounded: true
                  indicator:
                    arc_color: 0x999999
                    arc_width: 12
                    arc_rounded: true
                  knob:
                    bg_color: 0xFFFFFF
                    radius: 14
                    width: 28
                    height: 28
                    border_width: 0
                  on_value:
                    - lvgl.label.update:
                        id: volume_pct_label
                        text: !lambda |-
                          char buf[8];
                          snprintf(buf, sizeof(buf), "%d%%", (int)x);
                          return std::string(buf);
                    - script.execute: debounce_volume

              # "Volume" label above the percentage
              - label:
                  id: volume_title_label
                  text: "Volume"
                  text_font: roboto19_font
                  text_color: 0x888888
                  align: center
                  y: -60
                  width: 140
                  height: 24
                  text_align: center

              # Large centered percentage label (overlaid on top of the arc)
              - label:
                  id: volume_pct_label
                  text: "30%"
                  text_font: roboto56_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -10
                  width: 200
                  height: 60
                  text_align: center

              # Volume down button
              - button:
                  id: volume_down_button
                  align: center
                  x: -48
                  y: 135
                  width: 72px
                  height: 72px
                  styles: control_round
                  widgets:
                    - label:
                        text_font: $icon_font
                        align: center
                        text: $icon_minus
                        text_color: 0xFFFFFF
                  on_press:
                    - lvgl.arc.update:
                        id: volume_arc
                        value: !lambda |-
                          int v = lv_arc_get_value(id(volume_arc)) - 1;
                          if (v < 0) v = 0;
                          return v;

              # Volume up button
              - button:
                  id: volume_up_button
                  align: center
                  x: 48
                  y: 135
                  width: 72px
                  height: 72px
                  styles: control_round
                  widgets:
                    - label:
                        text_font: $icon_font
                        align: center
                        text: $icon_plus
                        text_color: 0xFFFFFF
                  on_press:
                    - lvgl.arc.update:
                        id: volume_arc
                        value: !lambda |-
                          int v = lv_arc_get_value(id(volume_arc)) + 1;
                          if (v > 100) v = 100;
                          return v;

              # Drag handle indicator (visual cue to swipe up to close)
              - obj:
                  x: 210
                  y: 466
                  width: 60
                  height: 4
                  bg_color: 0x666666
                  bg_opa: 100%
                  radius: 2
                  border_width: 0
                  pad_all: 0
                  scrollable: false

        # ---------------------------------------------------------------
        # HOME ASSISTANT SETUP PROMPT (WiFi connected, HA not yet)
        # ---------------------------------------------------------------
        # Shown after WiFi connects but before HA API connects.
        # Hidden by api on_client_connected; shown by on_client_disconnected.
        # ---------------------------------------------------------------
        - obj:
            id: ha_setup_prompt
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            widgets:
              - label:
                  text_font: $icon_font
                  align: center
                  y: -80
                  text: $icon_ha
                  text_color: 0xFFFFFF
              - label:
                  text: "Home Assistant"
                  text_font: roboto30_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -20
                  width: 400
                  height: 36
                  text_align: center
              - label:
                  id: ha_setup_instructions
                  text: "Add this device in\nSettings > Devices > ESPHome"
                  text_font: roboto19_font
                  text_color: 0x888888
                  align: center
                  y: 40
                  width: 400
                  height: 80
                  text_align: center

        # ---------------------------------------------------------------
        # WIFI SETUP PROMPT (shown when WiFi is not connected)
        # ---------------------------------------------------------------
        # Full-screen overlay shown on first boot (or whenever WiFi drops).
        # Hidden by wifi on_connect; shown by wifi on_disconnect.
        # Rendered last so it covers the HA prompt when both apply.
        # ---------------------------------------------------------------
        - obj:
            id: wifi_setup_prompt
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: true
            widgets:
              - label:
                  text_font: $icon_font
                  align: center
                  y: -80
                  text: $icon_wifi
                  text_color: 0xFFFFFF
              - label:
                  text: "WiFi Setup"
                  text_font: roboto30_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -20
                  width: 300
                  height: 36
                  text_align: center
              - label:
                  id: wifi_setup_instructions
                  text: "Connect to the WiFi hotspot\nto configure your network"
                  text_font: roboto19_font
                  text_color: 0x888888
                  align: center
                  y: 40
                  width: 400
                  height: 80
                  text_align: center

        # ---------------------------------------------------------------
        # LOADING SCREEN (shown at boot until WiFi/grace period)
        # ---------------------------------------------------------------
        # Full-screen overlay, visible by default. Hidden when connected or
        # when grace period ends. Status and progress updated from network.yaml.
        # ---------------------------------------------------------------
        - obj:
            id: loading_screen
            x: 0
            y: 0
            width: 480
            height: 480
            bg_color: 0x000000
            bg_opa: 100%
            radius: 0
            border_width: 0
            pad_all: 0
            scrollable: false
            scrollbar_mode: "off"
            hidden: false
            widgets:
              - label:
                  text: "Starting up"
                  text_font: roboto30_font
                  text_color: 0xFFFFFF
                  align: center
                  y: -20
                  width: 400
                  height: 36
                  text_align: center
              - bar:
                  id: loading_progress_bar
                  align: center
                  y: 20
                  width: 120
                  height: 4
                  bg_color: 0x333333
                  bg_opa: 100%
                  radius: 3
                  min_value: 0
                  max_value: 100
                  value: 0
                  indicator:
                    bg_color: 0xFFFFFF
                    radius: 3
