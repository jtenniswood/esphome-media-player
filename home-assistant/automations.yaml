# =============================================================================
# AUTOMATION â€” Convert Album Art for ESPHome
# =============================================================================
# Triggers when the media player's album art changes, converts the image
# to baseline JPEG, and notifies ESPHome via an input_text helper.
#
# Change "media_player.office" to match YOUR media player entity.
#
# You can add this via the HA UI (Settings > Automations) or paste into
# your automations.yaml file.
# =============================================================================

- alias: "Convert Album Art for ESPHome"
  description: "Download album art, convert progressive JPEG to baseline, update ESPHome"
  trigger:
    - platform: state
      entity_id: media_player.office
      attribute: entity_picture
  condition:
    - condition: template
      value_template: >-
        {{ trigger.to_state.attributes.entity_picture is defined
           and trigger.to_state.attributes.entity_picture not in ['', None] }}
  action:
    - service: shell_command.convert_album_art
    - delay:
        seconds: 2
    - service: input_text.set_value
      data:
        entity_id: input_text.album_art_url
        value: "/local/album_art.jpg?v={{ now().timestamp() | int }}"
