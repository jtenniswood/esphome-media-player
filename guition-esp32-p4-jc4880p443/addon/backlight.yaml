# =============================================================================
# BACKLIGHT & SCREENSAVER - P4 JC4880P443
# =============================================================================
# Same two-stage screensaver as S3. Backlight output from device/device.yaml.
# =============================================================================

light:
  - platform: monochromatic
    name: Backlight
    id: backlight
    output: backlight_output
    restore_mode: ALWAYS_ON
    default_transition_length: 1s
    internal: true

text_sensor:
  - platform: homeassistant
    entity_id: sun.sun
    id: sun_state_sensor
    internal: true

number:
  - platform: template
    name: "Day Dim Brightness"
    id: backlight_day_brightness
    min_value: 0
    max_value: 100
    step: 5
    initial_value: 35
    optimistic: true
    restore_value: true
    unit_of_measurement: "%"
    icon: "mdi:brightness-5"
    entity_category: config

  - platform: template
    name: "Night Dim Brightness"
    id: backlight_night_brightness
    min_value: 0
    max_value: 100
    step: 5
    initial_value: 25
    optimistic: true
    restore_value: true
    unit_of_measurement: "%"
    icon: "mdi:brightness-3"
    entity_category: config

  - platform: template
    name: "Dim Timeout"
    id: backlight_dim_timeout
    min_value: 1
    max_value: 300
    step: 1
    initial_value: 60
    optimistic: true
    restore_value: true
    unit_of_measurement: "s"
    icon: "mdi:timer-outline"
    entity_category: config

  - platform: template
    name: "Screen Off Timeout"
    id: backlight_off_timeout
    min_value: 1
    max_value: 600
    step: 1
    initial_value: 300
    optimistic: true
    restore_value: true
    unit_of_measurement: "s"
    icon: "mdi:timer-off-outline"
    entity_category: config

switch:
  - platform: template
    name: "Daytime Screen Saver"
    id: backlight_day_screen_off
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    icon: "mdi:monitor-off"
    entity_category: config

  - platform: template
    name: "Nighttime Screen Saver"
    id: backlight_night_screen_off
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    icon: "mdi:monitor-off"
    entity_category: config

script:
  - id: backlight_wake_timeout
    mode: restart
    then:
      - lambda: 'id(is_screen_dimmed) = false;'
      - light.turn_on:
          id: backlight
          brightness: 100%
          transition_length: 1s
      - lvgl.resume:
      - delay: !lambda 'return (uint32_t)(id(backlight_dim_timeout).state * 1000);'
      - if:
          condition:
            lambda: >-
              return !id(media_player_state_sensor).has_state() ||
                     id(media_player_state_sensor).state != "playing";
          then:
            - lambda: 'id(is_screen_dimmed) = true;'
            - light.turn_on:
                id: backlight
                brightness: !lambda |-
                  bool is_day = id(sun_state_sensor).has_state() &&
                                id(sun_state_sensor).state == "above_horizon";
                  float pct = is_day
                    ? id(backlight_day_brightness).state
                    : id(backlight_night_brightness).state;
                  return pct / 100.0f;
                transition_length: 3s
            - if:
                condition:
                  lambda: |-
                    bool is_day = id(sun_state_sensor).has_state() &&
                                  id(sun_state_sensor).state == "above_horizon";
                    return is_day
                      ? id(backlight_day_screen_off).state
                      : id(backlight_night_screen_off).state;
                then:
                  - delay: !lambda 'return (uint32_t)(id(backlight_off_timeout).state * 1000);'
                  - light.turn_off:
                      id: backlight
                      transition_length: 3s
                  - lvgl.pause:
