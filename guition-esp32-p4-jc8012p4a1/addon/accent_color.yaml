# =============================================================================
# ACCENT COLOR - Extract dominant color from album art
# =============================================================================
# Samples edge pixels from the downloaded artwork to derive a representative
# colour, then applies it to the accent_bg_panel widget background.
# No Home Assistant dependencies â€” runs entirely on-device after each
# successful image download.
# =============================================================================

script:
  - id: extract_accent_color
    mode: restart
    then:
      - lambda: |-
          auto *img = id(album_art_background);
          int img_w = img->get_width();
          int img_h = img->get_height();
          if (img_w <= 0 || img_h <= 0) return;

          long r_sum = 0, g_sum = 0, b_sum = 0;
          int count = 0;
          int step_x = img_w > 10 ? img_w / 10 : 1;
          int step_y = img_h > 10 ? img_h / 10 : 1;

          for (int x = 0; x < img_w; x += step_x) {
            auto c = img->get_pixel(x, 0);
            r_sum += c.r; g_sum += c.g; b_sum += c.b; count++;
            c = img->get_pixel(x, img_h - 1);
            r_sum += c.r; g_sum += c.g; b_sum += c.b; count++;
          }
          for (int y = 0; y < img_h; y += step_y) {
            auto c = img->get_pixel(0, y);
            r_sum += c.r; g_sum += c.g; b_sum += c.b; count++;
            c = img->get_pixel(img_w - 1, y);
            r_sum += c.r; g_sum += c.g; b_sum += c.b; count++;
          }

          if (count > 0) {
            int r = r_sum / count, g = g_sum / count, b = b_sum / count;
            ESP_LOGI("accent", "Accent color: rgb(%d,%d,%d) from %d edge samples", r, g, b, count);
            lv_obj_set_style_bg_color(id(accent_bg_panel), lv_color_make(r, g, b), 0);
          }
