# =============================================================================
# ACCENT COLOR - Extract dominant color from album art
# =============================================================================
# Samples a grid of pixels across the downloaded artwork, weights each sample
# by its colour saturation so vivid pixels dominate over blacks/whites/grays,
# and applies the result to the accent_bg_panel widget background.
# No Home Assistant dependencies â€” runs entirely on-device.
# =============================================================================

script:
  - id: extract_accent_color
    mode: restart
    then:
      - lambda: |-
          auto *img = id(album_art_background);
          int img_w = img->get_width();
          int img_h = img->get_height();
          if (img_w <= 0 || img_h <= 0) return;

          int grid = 12;
          int step_x = img_w / grid;
          int step_y = img_h / grid;
          if (step_x < 1) step_x = 1;
          if (step_y < 1) step_y = 1;

          int64_t r_wsum = 0, g_wsum = 0, b_wsum = 0;
          int64_t w_total = 0;

          for (int y = step_y / 2; y < img_h; y += step_y) {
            for (int x = step_x / 2; x < img_w; x += step_x) {
              auto c = img->get_pixel(x, y);
              int r = c.r, g = c.g, b = c.b;

              int mx = r > g ? (r > b ? r : b) : (g > b ? g : b);
              int mn = r < g ? (r < b ? r : b) : (g < b ? g : b);
              int sat = mx - mn;

              int weight = sat * sat + 1;
              r_wsum += (int64_t)r * weight;
              g_wsum += (int64_t)g * weight;
              b_wsum += (int64_t)b * weight;
              w_total += weight;
            }
          }

          if (w_total > 0) {
            int r = (int)(r_wsum / w_total);
            int g = (int)(g_wsum / w_total);
            int b = (int)(b_wsum / w_total);
            ESP_LOGI("accent", "Accent color: rgb(%d,%d,%d)", r, g, b);
            lv_obj_set_style_bg_color(id(accent_bg_panel), lv_color_make(r, g, b), 0);
          }
